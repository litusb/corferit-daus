<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Corferit</title>

<style>
body { font-family: sans-serif; background: #222; color: #eee; text-align: center; padding: 20px; }
.btn { margin: 10px; padding: 12px 22px; background: #444; color: #fff; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; }
#result { margin-top: 20px; font-size: 26px; }
#history { margin-top: 20px; text-align: left; width: 320px; margin-left: auto; margin-right: auto; max-height: 300px; overflow-y: auto; }
.esperan√ßa { color: #FFD700; font-weight: bold; }
.por { color: #800080; font-weight: bold; }
#roomLabel { opacity: 0.7; margin-bottom: 10px; }
#loginBox input { padding:8px; margin:5px; width:200px; }
#loginBox { margin-bottom: 20px; }
</style>
</head>

<body>

<h1>üé≤ Corferit</h1>

<div id="loginBox">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button class="btn" onclick="login()">Entrar</button>
</div>

<div id="app" style="display:none;">

<div id="roomLabel"></div>
<input id="playerName" placeholder="Tu nombre" style="padding:8px;margin-bottom:10px"><br>

<button class="btn" onclick="rollDuality(0)">D-</button>
<button class="btn" onclick="rollDuality()">‚¨°‚¨¢</button>
<button class="btn" onclick="rollDuality(1)">A+</button>

<div id="result"></div>

<h3>Historial compartido</h3>
<div id="history"></div>

<br>
<button class="btn" onclick="logout()">Cerrar sesi√≥n</button>

</div>

<script type="module">

// üîπ Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// üîπ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCLRBsJDKcv9I0hf3uosB0F3w7rXWU-40A",
  authDomain: "corferit-daus.firebaseapp.com",
  projectId: "corferit-daus",
  storageBucket: "corferit-daus.firebasestorage.app",
  messagingSenderId: "756634249064",
  appId: "1:756634249064:web:8e09d8bf75aebcb1b118dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// üîπ Sala desde URL
function getRoomFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("room") || "sala-general";
}

const roomName = getRoomFromURL();
document.getElementById("roomLabel").innerText = "Sala: " + roomName;

const rollsRef = collection(db, `rooms/${roomName}/rolls`);
const q = query(rollsRef, orderBy("time", "desc"));

// üîê LOGIN
window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch (error) {
    alert("Error de login: " + error.message);
  }
}

// üîê LOGOUT
window.logout = async function() {
  await signOut(auth);
}

// üîê Estado de autenticaci√≥n
onAuthStateChanged(auth, (user) => {
  if (user) {
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("app").style.display = "block";
    startApp();
  } else {
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("app").style.display = "none";
  }
});

// üîπ Firestore en tiempo real
function startApp() {
  onSnapshot(q, (snapshot) => {
    const historyDiv = document.getElementById("history");
    historyDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const data = doc.data();
      historyDiv.innerHTML += `<div>${data.text}</div><hr>`;
    });
  });
}

// üé≤ Dados
window.rollD12 = function() { return Math.floor(Math.random() * 12) + 1; }
window.rollD6 = function() { return Math.floor(Math.random() * 6) + 1; }

window.rollDuality = async function(v) {
  const esperan√ßa = rollD12();
  const por = rollD12();
  const d6 = rollD6();

  let winner = "";
  let final = esperan√ßa + por;
  let colorClass = "";

  if (esperan√ßa >= por) {
    winner = "Esperan√ßa";
    colorClass = "esperan√ßa";
  } else {
    winner = "Por";
    colorClass = "por";
  }

  let modifierText = "";
  if (v == 1) { final += d6; modifierText = ` | +‚öÖ ${d6}`; }
  else if (v == 0) { final -= d6; modifierText = ` | -‚öÖ ${d6}`; }

  const player = document.getElementById("playerName").value || auth.currentUser.email;

  const text = `<strong>${player}</strong><br>‚¨° ${esperan√ßa} | ‚¨¢ ${por}${modifierText}<br><strong>${final}</strong> amb <span class="${colorClass}">${winner}</span>.`;

  document.getElementById("result").innerHTML = text;

  await addDoc(rollsRef, { text: text, time: Date.now() });
}

</script>
</body>
</html>
