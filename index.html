<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Corferit - Daggerheart</title>

<style>
body {
  font-family: sans-serif;
  background: #111;
  color: #eee;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
}

#container {
  background: #222;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
  max-width: 420px;
  width: 100%;
  text-align: center;
}

.btn {
  margin: 8px;
  padding: 12px 22px;
  background: #444;
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 18px;
  cursor: pointer;
}

#result { margin-top: 20px; font-size: 22px; }
#history { margin-top: 20px; text-align: left; max-height: 250px; overflow-y: auto; }
.esperan√ßa { color: #FFD700; font-weight: bold; }
.por { color: #FF4500; font-weight: bold; }

input { padding: 8px; margin: 5px; width: 90%; border-radius:5px; border:none; }
#usersList { margin-top:15px; text-align:left; max-height:150px; overflow-y:auto; border-top:1px solid #555; padding-top:10px; }
</style>
</head>

<body>

<div id="container">

<h1>üé≤ Corferit</h1>

<!-- LOGIN -->
<div id="loginBox">
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Contrase√±a"><br>
  <button class="btn" onclick="login()">Entrar</button>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div id="roomLabel"></div>
  <input id="playerName" placeholder="Tu nombre"><br>

  <button class="btn" onclick="rollDuality(0)">D-</button>
  <button class="btn" onclick="rollDuality()">‚¨°‚¨¢</button>
  <button class="btn" onclick="rollDuality(1)">A+</button>

  <div id="result"></div>

  <h3>Historial compartido</h3>
  <div id="history"></div>

  <h3>Puntos DJ: <span id="djPoints">0</span></h3>

  <h3>Jugadores conectados</h3>
  <div id="usersList"></div>

  <button class="btn" onclick="logout()">Cerrar sesi√≥n</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, doc, updateDoc, getDoc, increment }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// üîπ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCLRBsJDKcv9I0hf3uosB0F3w7rXWU-40A",
  authDomain: "corferit-daus.firebaseapp.com",
  projectId: "corferit-daus",
  storageBucket: "corferit-daus.firebasestorage.app",
  messagingSenderId: "756634249064",
  appId: "1:756634249064:web:8e09d8bf75aebcb1b118dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// üîπ Lista blanca de salas
const allowedRooms = ["daggerheart", "sala-general"];
function getRoomFromURL() {
  const params = new URLSearchParams(window.location.search);
  const r = params.get("room") || "sala-general";
  return allowedRooms.includes(r) ? r : "sala-general";
}
const roomName = getRoomFromURL();
document.getElementById("roomLabel").innerText = "Sala: " + roomName;

const rollsRef = collection(db, `rooms/${roomName}/rolls`);
const usersRef = collection(db, `rooms/${roomName}/users`);
const roomRef = doc(db, `rooms/${roomName}`);
const maxRolls = 50;

// üîê LOGIN
window.login = async function() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth,email,password); }
  catch(e){ alert("Error login: "+e.message); }
}

// üîê LOGOUT
window.logout = async function() {
  if(auth.currentUser){
    await updateDoc(doc(usersRef,auth.currentUser.uid),{connected:false});
  }
  await signOut(auth);
}

// üîê Estado de autenticaci√≥n
onAuthStateChanged(auth, async (user) => {
  if(user){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("app").style.display="block";

    const userRef = doc(usersRef,user.uid);
    const playerName = document.getElementById("playerName").value || user.email;

    const userDoc = await getDoc(userRef);
    if(!userDoc.exists()){
      await addDoc(usersRef,{name:playerName,hopePoints:0,connected:true,lastSeen:Date.now()});
    } else {
      await updateDoc(userRef,{connected:true,lastSeen:Date.now(),name:playerName});
    }

    // Crear documento de sala con DJ si no existe
    const roomDoc = await getDoc(roomRef);
    if(!roomDoc.exists()){
      await updateDoc(doc(db,"dummy"),{}).catch(()=>{}); // workaround
      await updateDoc(roomRef,{djFearPoints:0}).catch(async ()=>{await setDoc(roomRef,{djFearPoints:0});});
    }

    startApp();
  } else {
    document.getElementById("loginBox").style.display="block";
    document.getElementById("app").style.display="none";
  }
});

// üîπ Firestore en tiempo real
function startApp(){

  // Historial tiradas
  const qRolls = query(rollsRef, orderBy("time","desc"), limit(maxRolls));
  onSnapshot(qRolls, snapshot => {
    const historyDiv = document.getElementById("history");
    historyDiv.innerHTML = "";
    snapshot.forEach(doc => {
      historyDiv.innerHTML += `<div>${doc.data().text}</div><hr>`;
    });
  });

  // Lista jugadores
  const qUsers = query(usersRef);
  onSnapshot(qUsers, snapshot => {
    const usersDiv = document.getElementById("usersList");
    usersDiv.innerHTML = "";
    snapshot.forEach(doc=>{
      const u = doc.data();
      if(u.connected) usersDiv.innerHTML += `üéØ ${u.name} | Esperan√ßa: ${u.hopePoints}<br>`;
    });
  });

  // DJ puntos
  onSnapshot(roomRef, snapshot=>{
    const roomData = snapshot.data();
    document.getElementById("djPoints").innerText = roomData ? roomData.djFearPoints||0 : 0;
  });

}

// üé≤ Dados
window.rollD12 = ()=>Math.floor(Math.random()*12)+1;
window.rollD6 = ()=>Math.floor(Math.random()*6)+1;

// Tirada Duality con reglas personalizadas
window.rollDuality = async function(v){
  const esperan√ßa=rollD12(), por=rollD12(), d6=rollD6();
  let winner="", final=esperan√ßa+por;
  if(v==1){ final+=d6; }
  else if(v==0){ final-=d6; }

  const playerName = document.getElementById("playerName").value || auth.currentUser.email;
  const userRef = doc(usersRef,auth.currentUser.uid);

  // Determinar ganador
  if(esperan√ßa === por){
    winner="crit";
  } else if(esperan√ßa > por){
    winner="esperan√ßa";
  } else {
    winner="por";
  }

  // Actualizar puntos
  if(winner==="crit" || winner==="esperan√ßa"){
    await updateDoc(userRef,{hopePoints: increment(1)});
  }
  if(winner==="por"){
    await updateDoc(roomRef,{djFearPoints: increment(1)});
  }

  // Texto tirada
  let colorClass="";
  if(winner==="esperan√ßa" || winner==="crit"){ colorClass="esperan√ßa"; }
  else if(winner==="por"){ colorClass="por"; }

  let modifierText="";
  if(v==1){ modifierText=` | +‚öÖ ${d6}`; }
  else if(v==0){ modifierText=` | -‚öÖ ${d6}`; }

  const text=`<strong>${playerName}</strong><br>‚¨° ${esperan√ßa} | ‚¨¢ ${por}${modifierText}<br><strong>${final}</strong> amb <span class="${colorClass}">${winner==="crit"?"CR√çTICA":winner}</span>.`;

  document.getElementById("result").innerHTML=text;

  // Guardar tirada
  await addDoc(rollsRef,{text:text,time:Date.now()});

}
</script>
</body>
</html>
