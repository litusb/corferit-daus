<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Corferit</title>

<style>
  body { font-family: sans-serif; background: #222; color: #eee; text-align: center; padding: 20px; }
  .btn { margin: 10px; padding: 12px 22px; background: #444; color: #fff; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; }
  #result { margin-top: 20px; font-size: 26px; }
  #history { margin-top: 20px; text-align: left; width: 320px; margin-left: auto; margin-right: auto; max-height: 300px; overflow-y: auto; }
  .esperan√ßa { color: #FFD700; font-weight: bold; }
  .por { color: #800080; font-weight: bold; }
</style>
</head>

<body>

<h1>üé≤ Corferit</h1>

<input id="playerName" placeholder="Tu nombre" style="padding:8px;margin-bottom:10px">

<br>

<button class="btn" onclick="rollDuality(0)">D-</button>
<button class="btn" onclick="rollDuality()">‚¨°‚¨¢</button>
<button class="btn" onclick="rollDuality(1)">A+</button>

<div id="result"></div>

<h3>Historial compartido</h3>
<div id="history"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCLRBsJDKcv9I0hf3uosB0F3w7rXWU-40A",
  authDomain: "corferit-daus.firebaseapp.com",
  projectId: "corferit-daus",
  storageBucket: "corferit-daus.firebasestorage.app",
  messagingSenderId: "756634249064",
  appId: "1:756634249064:web:8e09d8bf75aebcb1b118dd"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// referencia a la sala
const rollsRef = collection(db, "rooms/sala-1/rolls");

// escuchar en tiempo real
const q = query(rollsRef, orderBy("time", "desc"));

onSnapshot(q, (snapshot) => {
  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = "";

  snapshot.forEach(doc => {
    const data = doc.data();
    historyDiv.innerHTML += `<div>${data.text}</div><hr>`;
  });
});

// enviar tirada a Firestore
async function sendRoll(text) {
  const player = document.getElementById("playerName").value || "An√≥nimo";

  await addDoc(rollsRef, {
    player: player,
    text: `<strong>${player}</strong><br>${text}`,
    time: Date.now()
  });
}

// funciones globales
window.rollD12 = function() {
  return Math.floor(Math.random() * 12) + 1;
}

window.rollD6 = function() {
  return Math.floor(Math.random() * 6) + 1;
}

window.rollDuality = async function(v) {

  const esperan√ßa = rollD12();
  const por = rollD12();
  const d6 = rollD6();

  let winner = "";
  let final = esperan√ßa + por;
  let colorClass = "";

  if (esperan√ßa >= por) {
    winner = "Esperan√ßa";
    colorClass = "esperan√ßa";
  } else {
    winner = "Por";
    colorClass = "por";
  }

  let modifierText = "";

  if (v == 1) {
    final += d6;
    modifierText = ` | +‚öÖ ${d6}`;
  } else if (v == 0) {
    final -= d6;
    modifierText = ` | -‚öÖ ${d6}`;
  }

  const text = `
    ‚¨° ${esperan√ßa} | ‚¨¢ ${por}${modifierText}<br>
    <strong>${final}</strong> amb <span class="${colorClass}">${winner}</span>.
  `;

  document.getElementById("result").innerHTML = text;

  await sendRoll(text);
}

</script>

</body>
</html>
